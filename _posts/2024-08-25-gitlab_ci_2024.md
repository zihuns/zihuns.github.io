---
title: GitLab CI Ã— Slack Webhook | ê°€ì´ë“œ- MR ì•Œë¦¼Â·Draft í† ê¸€Â·ì¶©ëŒ ê°ì§€
date: 2024-08-20 01:00:00 +09:00
lastmod: 2025-09-21 14:30:00 +0900
categories: [DevOps, CI-CD]
tags: [
  gitlab-ci, slack-webhook, merge-request, external-include, pipeline, bash,
  alerting, predefined-variables
]
---

> ğŸ“Œ ì´ ê¸€ì€ **GitLab CI Ã— Slack Webhook** ì¤‘ 4í¸ì…ë‹ˆë‹¤.  
> 1í¸: [Freeze-Free MR Pipeline ì„¤ê³„](/posts/gitlab_ci_0)  
> 2í¸: [Freeze-Window ì°¨ë‹¨Â·MR ì•Œë¦¼Â·ì™¸ë¶€ Include ìë™í™”](/posts/gitlab_ci_1)  
> 3í¸: [ì‚¬ìš©ìë³„ í”„ë¡œí•„ ì´ëª¨ì§€ ë§ì¶¤ ì ìš©](/posts/gitlab_ci_2)  

---

## 1. ì£¼ìš” ê¸°ëŠ¥ ìš”ì•½

### Slack Incoming Webhook (mr_machine job)
- MR ìƒì„± ì‹œ ìë™ìœ¼ë¡œ ìŠ¬ë™ ë©”ì‹œì§€ ì „ì†¡
- ëŒ€ìƒ ê·¸ë£¹ í˜¸ì¶œ(@here, @fsd_display, @fsd_search)
- Draft: ì œëª©ìœ¼ë¡œ ì•Œë¦¼ ë¹„í™œì„±í™”
- MR ì¶©ëŒ ê°ì§€ ë° ì•Œë¦¼

---

## 2. ì‚¬ìš©ë²•

### 2-1. MR ì•Œë¦¼ on/off ì„¤ì •
MR ìƒì„± ì‹œ ê¸°ë³¸ì ìœ¼ë¡œ ìŠ¬ë™ ì•Œë¦¼ì´ ì „ì†¡ë©ë‹ˆë‹¤. ì•Œë¦¼ì„ ë¹„í™œì„±í™”í•˜ë ¤ë©´ MR ì œëª©ì„ `Draft:`ë¡œ ì‹œì‘í•˜ì„¸ìš”.
ë‹¤ì‹œ í™œì„±í™”í•˜ë ¤ë©´ Mark as readyë¥¼ í´ë¦­í•˜ê±°ë‚˜, ì»¤ë°‹ ì¶”ê°€/íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ì„ í•˜ë©´ ë©ë‹ˆë‹¤. (ìš°ì¸¡ ìƒë‹¨ ì  3ê°œ [ â‹® ] ë©”ë‰´ì—ì„œ Draft/Ready í† ê¸€ ê°€ëŠ¥)

![MR ì•Œë¦¼ on/off](/assets/img/gitlab_ci_2024/gitlab_ci_2024_1.png)
![MR ì•Œë¦¼ Draft ì˜ˆì‹œ](/assets/img/gitlab_ci_2024/gitlab_ci_2024_2.png)
![MR ì•Œë¦¼ Ready ì˜ˆì‹œ](/assets/img/gitlab_ci_2024/gitlab_ci_2024_3.png)

### 2-2. ëŒ€ìƒ ê·¸ë£¹ í˜¸ì¶œ
MR ìƒì„± ì‹œ labelsì—ì„œ @here, @fsd_display, @fsd_search ë“± ì›í•˜ëŠ” ê·¸ë£¹ì„ ì„ íƒí•˜ë©´ í•´ë‹¹ ê·¸ë£¹ì´ ìŠ¬ë™ ë©”ì‹œì§€ì—ì„œ í˜¸ì¶œë©ë‹ˆë‹¤.
![ëŒ€ìƒ ê·¸ë£¹ í˜¸ì¶œ ì˜ˆì‹œ2](/assets/img/gitlab_ci_2024/gitlab_ci_2024_4.png)

---

## 3. ìì£¼ ë°œìƒí•˜ëŠ” ë¬¸ì œì™€ í•´ê²°ë²•

1. **slack ì•Œë¦¼ì´ ì˜¤ì§€ ì•ŠìŒ**  
â†’ SLACK_URL ë³€ìˆ˜ê°€ ëˆ„ë½ëœ ê²½ìš°ì…ë‹ˆë‹¤. Settings > CI/CD > Variablesì—ì„œ SLACK_URLì„ ë“±ë¡í•˜ì„¸ìš”.

1. **í”„ë¡œí•„ ì‚¬ì§„ ëŒ€ì‹  ê¸€ìë§Œ ë‚˜ì˜´**  
â†’ GitLab ì‚¬ìš©ì ì´ë¦„ì„ ê·œì¹™ì— ë§ê²Œ ë³€ê²½í•˜ê±°ë‚˜, Slackì— í•´ë‹¹ ì´ëª¨ì§€ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.

1. **í”„ë¦¬ì§• ê¸°ê°„ì— ê¸´ê¸‰ ë°°í¬ í•„ìš”**  
â†’ Settings > CI/CD > Variablesì—ì„œ í”„ë¦¬ì§• ê¸°ê°„ ë³€ìˆ˜(F_S_DATE, F_E_DATE)ë¥¼ ì„ì‹œë¡œ ë³€ê²½ í›„, ë°°í¬ê°€ ëë‚˜ë©´ ì›ë˜ ê°’ìœ¼ë¡œ ë³µêµ¬í•˜ì„¸ìš”.

---

## 4. ì£¼ìš” ì½”ë“œ ë° í•´ì„¤


.gitlab-ci.yml
```yaml
variables:
  TB: ${CI_MERGE_REQUEST_TARGET_BRANCH_NAME}
  SB: ${CI_MERGE_REQUEST_SOURCE_BRANCH_NAME}
  MR_URL: ${CI_MERGE_REQUEST_PROJECT_URL}/-/merge_requests/${CI_MERGE_REQUEST_IID}
  CHN: channel # Slack ì±„ë„ëª… (# prefix ì œì™¸)
  PROFILE: "${GITLAB_USER_NAME%%(*}" # (í™ê¸¸ë™(foobar) â†’ í™ê¸¸ë™)
```

```yaml
stages: [build]

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Slack ì•Œë¦¼ Job
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
mr_machine:
stage: build
script: |
  # 1. Webhook ì „ì†¡ í•¨ìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    send_slack_message() {
      username="$1"
      text="$2"
      icon_emoji="$3"
      curl -X POST -H "Content-type: application/json" --data "{\"channel\": \"#${CHN}\", \"username\": \"${username}\", \"text\":\"${text}\", \"icon_emoji\": \":${icon_emoji}:\" }" $SLACK_URL
    }


  # 2. MR ê³µí†µ ë©”ì‹œì§€ ë˜í¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    mr_message() {
      text="$1"
      txt="${ALARM}\n :gitlab: ${text} MR ë¦¬ë·° & ìŠ¹ì¸ ë¶€íƒë“œë¦½ë‹ˆë‹¤! \n:branch: ${SB} â†’ ${TB} ( <${MR_URL}|MR ë§í¬ - ${CI_PROJECT_NAME}> )"
      send_slack_message "${GITLAB_USER_NAME}" "$txt" "${PROFILE}"
    }

  # 3. ì•Œë¦¼ ëŒ€ìƒ ê·¸ë£¹ ë§¤í•‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    case "$CI_MERGE_REQUEST_LABELS" in
      *here*) ALARM="<!here>" ;;
      *display*) ALARM="<!subteam^id>" ;;
      *search*) ALARM="<!subteam^id>" ;;
    esac

  # 4. Draft ì œëª©ì´ë©´ ì¡°ìš©íˆ ì¢…ë£Œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  [[ "$CI_MERGE_REQUEST_TITLE" == Draft:* ]] && exit 0

  # 5. ì¶©ëŒ ì‚¬ì „ ì ê²€(í•„ìš” ì‹œ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if [ "$TB" != "master" ] || [[ "${SB:0:7}" != "feature" ]]; then
    git config --global --replace-all user.email  "$GITLAB_USER_EMAIL"
    git config --global --replace-all user.name   "$GITLAB_USER_NAME"
    git fetch origin "$SB" && git fetch origin "$TB"
    git checkout "origin/$SB"
    git merge    "origin/$TB"
  fi

  # 6. ë¸Œëœì¹˜ ìœ í˜•ë³„ ì•Œë¦¼ ë¶„ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if   [ "$TB" = "develop" ];                  then mr_message "dev"
  elif [[ "${TB:0:7}" = "release" ]];          then mr_message "release"
  elif [ "$TB" = "master" ] && [[ "${SB:0:6}" = "hotfix" ]]; then
      mr_message "hotfix"
  elif [ "$TB" = "master" ] && [[ "${SB:0:7}" != "release" ]]; then
      send_slack_message "ë§ˆìŠ¤í„°ìˆ˜í˜¸ì" \
        "<!here>\n :crossed_swords: master merge ë°œê²¬ :crossed_swords: \
  \n:${PROFILE}: ${GITLAB_USER_NAME}
  \n:gitlab: ${SB} â†’ ${TB} ( <${MR_URL}|MR ë§í¬ - ${CI_PROJECT_NAME}> )"
  "judge"
  echo "Master MR FAIL" > .job_status
  exit 93
  fi


  after_script:
  # ì‹¤íŒ¨ ì‹œ ì¶©ëŒ ì•Œë¦¼
  - |
    if [ !$(cat .job_status) ] && [ ${CI_JOB_STATUS} == "failed" ] ; then
      curl -X POST -H "Content-type: application/json" --data "{\"channel\": \"#channel\", \"username\": \"${GITLAB_USER_NAME}\", \"text\":\" :branch: ì¶©ëŒ ë°œìƒ :broken_branch:\n:í­ë°œ: ${SB} â†’ ${TB} ( <${MR_URL}|MR ë§í¬ - ${CI_PROJECT_NAME}> ) \", \"icon_emoji\": \":${GITLAB_USER_NAME%%(*}:\" }" $SLACK_URL
    fi

  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
```

---

## ğŸ—“ï¸ ì—…ë°ì´íŠ¸ ë‚´ì—­

- **2024-07-31:**  
  - ê·¸ë£¹ í˜¸ì¶œ ê¸°ëŠ¥ ì¶”ê°€
  - **ê°œë°œ ê¸°ê°„:** 24.07.31

- **2023-10-12:**  
  - MR ì¶©ëŒ ê°ì§€ ê¸°ëŠ¥ ì¶”ê°€
  - **ê°œë°œ ê¸°ê°„:** 23.10.10 - 23.10.12

- **2023-08-22:**  
  - `Draft:` í‚¤ì›Œë“œë¡œ ì•Œë¦¼ ì œì–´ ê¸°ëŠ¥ ì¶”ê°€
  - **ê°œë°œ ê¸°ê°„:** 23.08.17 - 23.08.22

---